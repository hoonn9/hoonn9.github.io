<!DOCTYPE html>













<html lang="kr-ko">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>[NestJS] Graphql File Upload - Hoons Blog</title>

  
  
  <meta name="description" content="graphql (apollo client)를 사용하는 프론트에서 파일 업로드 구현 중에 REST를 사용하지 않고 오직 Graphql로 파일 업로드를 해보고 싶다고 생각이 들었다. 작업 중이던 NestJS에 적용하다가 삽질했던거 공유해본다.
패키지 설치 NestJS npm install graphql-upload
React npm install apollo-upload-client
npm i -D @types/apollo-upload-client
apollo-upload-client mutation의 content-type을 json에서 multipart로 변환 및 operation, variables을 formData에 주입 해준다.
apollo client의 기존 httpLink를 createUploadLink하여 uploadLink로 대체해주는 것 만으로 적용 가능하다.
import { createUploadLink } from &#34;apollo-upload-client&#34;;  const httpLink = createUploadLink({  uri: GRAPHQL_URL,  credentials: &#34;include&#34;, });  const errorLink = onError(({ graphQLErrors, networkError }) =&gt; {  // ." />
  <meta name="author" content="" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://hoonn9.github.io/app.min.css" />

  
  <link rel="preload stylesheet" as="style" href="https://hoonn9.github.io/an-old-hope.min.css" />
  <script
    defer
    src="https://hoonn9.github.io/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  <link rel="preload" as="image" href="https://hoonn9.github.io/theme.png" />

  
  <link rel="preload" as="image" href="https://hoonn9.github.io/github.svg" />
  

  
  <link rel="icon" href="https://hoonn9.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://hoonn9.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.97.3" />

  
  

  
  
  
  
  
  
  
  
  
  <meta property="og:title" content="[NestJS] Graphql File Upload" />
<meta property="og:description" content="graphql (apollo client)를 사용하는 프론트에서 파일 업로드 구현 중에 REST를 사용하지 않고 오직 Graphql로 파일 업로드를 해보고 싶다고 생각이 들었다. 작업 중이던 NestJS에 적용하다가 삽질했던거 공유해본다.
패키지 설치 NestJS npm install graphql-upload
React npm install apollo-upload-client
npm i -D @types/apollo-upload-client
apollo-upload-client mutation의 content-type을 json에서 multipart로 변환 및 operation, variables을 formData에 주입 해준다.
apollo client의 기존 httpLink를 createUploadLink하여 uploadLink로 대체해주는 것 만으로 적용 가능하다.
import { createUploadLink } from &#34;apollo-upload-client&#34;;  const httpLink = createUploadLink({  uri: GRAPHQL_URL,  credentials: &#34;include&#34;, });  const errorLink = onError(({ graphQLErrors, networkError }) =&gt; {  // ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hoonn9.github.io/post/nodejs/nestjs/nestjs-graphql-file-upload/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-11T20:56:29+09:00" />
<meta property="article:modified_time" content="2022-01-11T20:56:29+09:00" />


  
  <meta itemprop="name" content="[NestJS] Graphql File Upload">
<meta itemprop="description" content="graphql (apollo client)를 사용하는 프론트에서 파일 업로드 구현 중에 REST를 사용하지 않고 오직 Graphql로 파일 업로드를 해보고 싶다고 생각이 들었다. 작업 중이던 NestJS에 적용하다가 삽질했던거 공유해본다.
패키지 설치 NestJS npm install graphql-upload
React npm install apollo-upload-client
npm i -D @types/apollo-upload-client
apollo-upload-client mutation의 content-type을 json에서 multipart로 변환 및 operation, variables을 formData에 주입 해준다.
apollo client의 기존 httpLink를 createUploadLink하여 uploadLink로 대체해주는 것 만으로 적용 가능하다.
import { createUploadLink } from &#34;apollo-upload-client&#34;;  const httpLink = createUploadLink({  uri: GRAPHQL_URL,  credentials: &#34;include&#34;, });  const errorLink = onError(({ graphQLErrors, networkError }) =&gt; {  // ."><meta itemprop="datePublished" content="2022-01-11T20:56:29+09:00" />
<meta itemprop="dateModified" content="2022-01-11T20:56:29+09:00" />
<meta itemprop="wordCount" content="491">
<meta itemprop="keywords" content="NestJS,Nest,typescript,apollo,upload,graphql," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[NestJS] Graphql File Upload"/>
<meta name="twitter:description" content="graphql (apollo client)를 사용하는 프론트에서 파일 업로드 구현 중에 REST를 사용하지 않고 오직 Graphql로 파일 업로드를 해보고 싶다고 생각이 들었다. 작업 중이던 NestJS에 적용하다가 삽질했던거 공유해본다.
패키지 설치 NestJS npm install graphql-upload
React npm install apollo-upload-client
npm i -D @types/apollo-upload-client
apollo-upload-client mutation의 content-type을 json에서 multipart로 변환 및 operation, variables을 formData에 주입 해준다.
apollo client의 기존 httpLink를 createUploadLink하여 uploadLink로 대체해주는 것 만으로 적용 가능하다.
import { createUploadLink } from &#34;apollo-upload-client&#34;;  const httpLink = createUploadLink({  uri: GRAPHQL_URL,  credentials: &#34;include&#34;, });  const errorLink = onError(({ graphQLErrors, networkError }) =&gt; {  // ."/>

  
  
</head>


  <body class="not-ready" data-menu="true">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://hoonn9.github.io/">Hoons Blog</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  
  <nav class="menu">
    
    <a class="" href="/">Home</a>
    
  </nav>
  

  
  <nav class="social">
    
    <a
      class="github"
      style="--url: url(./github.svg)"
      href="https://github.com/hoonn9"
      target="_blank"
    ></a>
    
  </nav>
  
</header>


    <main class="main">

<article class="post-single">
  <header class="post-title">
    <p>
      
      <time>Jan 11, 2022</time>
      
      
    </p>
    <h1>[NestJS] Graphql File Upload</h1>
  </header>
  <section class="post-content"><p>graphql (apollo client)를 사용하는 프론트에서 파일 업로드 구현 중에 REST를 사용하지 않고 오직 Graphql로 파일 업로드를 해보고 싶다고 생각이 들었다. 작업 중이던 NestJS에 적용하다가 삽질했던거 공유해본다.</p>
<h2 id="패키지-설치">패키지 설치</h2>
<h3 id="nestjs">NestJS</h3>
<p><code>npm install graphql-upload</code></p>
<h3 id="react">React</h3>
<p><code>npm install apollo-upload-client</code><br>
<code>npm i -D @types/apollo-upload-client</code></p>
<h2 id="apollo-upload-client">apollo-upload-client</h2>
<p>mutation의 content-type을 json에서 multipart로 변환 및 operation, variables을 formData에 주입 해준다.<br>
apollo client의 기존 httpLink를 createUploadLink하여 uploadLink로 대체해주는 것 만으로 적용 가능하다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">createUploadLink</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;apollo-upload-client&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">httpLink</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">createUploadLink</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uri</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">GRAPHQL_URL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">credentials</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;include&#34;</span>,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">errorLink</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">onError</span>(({ <span style="color:#a6e22e">graphQLErrors</span>, <span style="color:#a6e22e">networkError</span> }) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ApolloClient</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">link</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">from</span>([<span style="color:#a6e22e">errorLink</span>, <span style="color:#a6e22e">httpLink</span>]),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cache</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">InMemoryCache</span>(),
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>mutation gql 생성 해주고 파일의 필드명은 Upload (Scalar 타입)<br>
images variable 입력으로는 js의 File 객체를 넣어주면 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">UPLOAD_POST</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gql</span><span style="color:#e6db74">`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  mutation uploadPost($title: String!, $content: String, $images: [Upload!]) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    uploadPost(title: $title, content: $content, images: $images) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ok
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      error
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">uploadPostMutation</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useMutation</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">uploadPost</span>, <span style="color:#a6e22e">uploadPostVariables</span><span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">UPLOAD_POST</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">mutate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useCallback</span>(<span style="color:#66d9ef">async</span>(<span style="color:#a6e22e">values</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// files =&gt; File[]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> {<span style="color:#a6e22e">title</span>. <span style="color:#a6e22e">content</span>, <span style="color:#a6e22e">files</span>} <span style="color:#f92672">=</span> <span style="color:#a6e22e">values</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">data</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">uploadPostMutation</span>({
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">variables</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">title</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">content</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">images</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">files</span>,
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">error</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}, [])
</span></span></code></pre></div><h2 id="graphql-upload">graphql-upload</h2>
<p>Nest 프로젝트에서 다음과 같이 적용한다.</p>
<h3 id="maints">main.ts</h3>
<p>express app에 middleware로 graphqlUploadExpress를 추가해준다.<br>
graphql-upload가 graphql 요청에서 file을 Promise&laquo;FileUpload&raquo;형태로 주입해준다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">graphqlUploadExpress</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;graphql-upload&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">bootstrap</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>(<span style="color:#e6db74">&#39;/graphql&#39;</span>, <span style="color:#a6e22e">graphqlUploadExpress</span>({ <span style="color:#a6e22e">maxFileSize</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>, <span style="color:#a6e22e">maxFiles</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span> }));
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="dto">DTO</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">GraphQLUpload</span>, <span style="color:#a6e22e">FileUpload</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;graphql-upload&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">ArgsType</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UploadPostArgs</span> <span style="color:#66d9ef">extends</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...Fields
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">Field</span>((<span style="color:#a6e22e">type</span>) =&gt; [<span style="color:#a6e22e">GraphQLUpload</span>], { <span style="color:#a6e22e">nullable</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> })
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">images</span><span style="color:#f92672">:</span> Promise&lt;<span style="color:#f92672">FileUpload</span>&gt;[];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="resolver">Resolver</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">Mutation</span>((<span style="color:#a6e22e">returns</span>) =&gt; <span style="color:#a6e22e">UploadPostOutput</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">uploadPost</span>(<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">Args</span>() <span style="color:#a6e22e">args</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">UploadPostArgs</span>)<span style="color:#f92672">:</span> Promise&lt;<span style="color:#f92672">UploadPostOutput</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">images</span>, ...<span style="color:#a6e22e">fields</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">args</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">post</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">getManager</span>().<span style="color:#a6e22e">transaction</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">em</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">post</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">postService</span>.<span style="color:#a6e22e">create</span>(<span style="color:#a6e22e">fields</span>, <span style="color:#a6e22e">em</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">post</span>.<span style="color:#a6e22e">files</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fileService</span>.<span style="color:#a6e22e">uploadFiles</span>(<span style="color:#a6e22e">imageInputs</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">em</span>.<span style="color:#a6e22e">save</span>(<span style="color:#a6e22e">post</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">post</span>
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h3 id="fileservice">FileService</h3>
<p>FileUpload의 createReadStream을 실행하면 fs-capacitor를 사용하여 ReadStream 객체로 만들어준다.<br>
stream을 toBuffer 함수로 buffer만 추출한다.</p>
<p>추출한 Buffer와 mimetype 등 파일 객체 속성들로 업로드 하면 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">Injectable</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FileService</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...Services
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">readonly</span> <span style="color:#a6e22e">uploadService</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">UploadService</span>
</span></span><span style="display:flex;"><span>  ) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">toBuffer</span>(<span style="color:#a6e22e">stream</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ReadStream</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise&lt;<span style="color:#f92672">Buffer</span>&gt;((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">chunks</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Buffer</span>[] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buffer</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Buffer</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;data&#34;</span>, (<span style="color:#a6e22e">chunk</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">chunks</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">chunk</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">Buffer</span>);
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;end&#34;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Buffer</span>.<span style="color:#a6e22e">concat</span>(<span style="color:#a6e22e">chunks</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;error&#34;</span>, <span style="color:#a6e22e">reject</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">toUploadS3Input</span>(<span style="color:#a6e22e">file</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">FileUpload</span>)<span style="color:#f92672">:</span> Promise&lt;<span style="color:#f92672">UploadS3Input</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">stream</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">createReadStream</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">buffer</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">toBuffer</span>(<span style="color:#a6e22e">stream</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">mimetype</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">mimetype</span>,
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">uploadFiles</span>(<span style="color:#a6e22e">files</span><span style="color:#f92672">:</span> Promise&lt;<span style="color:#f92672">FileUpload</span>&gt;[]) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">inputs</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> Promise.<span style="color:#a6e22e">all</span>(<span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">map</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">file</span>) =&gt; <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">toUploadS3Input</span>(<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">file</span>)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">uploadService</span>.<span style="color:#a6e22e">upload</span>(<span style="color:#a6e22e">inputs</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="nest의-validationpipe-사용-시">Nest의 validationPipe 사용 시</h2>
<p><code>TypeError: Promise resolver undefined is not a function</code> 에러를 볼 수 있는데 이는 Nest의 validation pipe의 class transformer 단계에서 Promise처리가 불가능하여 발생하는 에러이다.</p>
<h3 id="exclude-옵션을-추가하여-validation에서-제외해준다">exclude 옵션을 추가하여 validation에서 제외해준다.</h3>
<h3 id="dto-1">DTO</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">ArgsType</span>, <span style="color:#a6e22e">Field</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;@nestjs/graphql&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">GraphQLUpload</span>, <span style="color:#a6e22e">FileUpload</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;graphql-upload&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">IsOptional</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;class-validator&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Exclude</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;class-transformer&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">ArgsType</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UploadPostInput</span> <span style="color:#66d9ef">extends</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...Fields
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">Exclude</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">IsOptional</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">Field</span>((<span style="color:#a6e22e">type</span>) =&gt; [<span style="color:#a6e22e">GraphQLUpload</span>], { <span style="color:#a6e22e">nullable</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> })
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">imageInputs</span><span style="color:#f92672">:</span> Promise&lt;<span style="color:#f92672">FileUpload</span>&gt;[];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section>

  
  
  <footer class="post-tags">
     
    <a href="https://hoonn9.github.io/tags/nestjs">NestJS</a>
     
    <a href="https://hoonn9.github.io/tags/nest">Nest</a>
     
    <a href="https://hoonn9.github.io/tags/typescript">typescript</a>
     
    <a href="https://hoonn9.github.io/tags/apollo">apollo</a>
     
    <a href="https://hoonn9.github.io/tags/upload">upload</a>
     
    <a href="https://hoonn9.github.io/tags/graphql">graphql</a>
    
  </footer>
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://hoonn9.github.io/post/nginx/x-forward-for/"><span>←</span><span>[Nginx] Client IP와 X-Forwared-For</span></a>
     
  </nav>
  

  
  
</article>

</main>

    <footer class="footer">
  <p>&copy; 2022 <a href="https://hoonn9.github.io/">Hoons Blog</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

  </body>
</html>
